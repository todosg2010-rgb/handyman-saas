from typing import Dict, List

НАСТРОЙКИ = {
    "часова_ставка": 45.0,
    "данък": 0.20,
    "общи_разходи": 0.10,
    "печалба": 0.30,
    "минимална_оферта": 120.0,
    "цена_на_км": 1.20,
    "такса_посещение": 15.0
}

МНОЖИТЕЛ_ТРУДНОСТ = {
    "лесна": 1.0,
    "средна": 1.25,
    "трудна": 1.5,
    "експертна": 2.0
}

def изчисли_оферта(данни: Dict) -> Dict:
    общо_материали = 0.0
    материали: List[Dict] = []

    for м in данни["материали"]:
        ред_общо = round(м["единична_цена"] * м["количество"], 2)
        общо_материали += ред_общо

        материали.append({
            "име": м["име"],
            "единична_цена": м["единична_цена"],
            "количество": м["количество"],
            "стойност": ред_общо
        })

    базов_труд = данни["часове"] * НАСТРОЙКИ["часова_ставка"]
    труд = round(
        базов_труд * МНОЖИТЕЛ_ТРУДНОСТ.get(данни["трудност"], 1.0),
        2
    )

    данък_труд = round(труд * НАСТРОЙКИ["данък"], 2)

    транспорт = round(
        НАСТРОЙКИ["такса_посещение"]
        + данни["разстояние"] * НАСТРОЙКИ["цена_на_км"],
        2
    )

    общи_разходи = round(
        (общо_материали + труд) * НАСТРОЙКИ["общи_разходи"],
        2
    )

    себестойност = round(
        общо_материали + труд + данък_труд + транспорт + общи_разходи,
        2
    )

    печалба = round(себестойност * НАСТРОЙКИ["печалба"], 2)
    оферта = round(себестойност + печалба, 2)

    if оферта < НАСТРОЙКИ["минимална_оферта"]:
        оферта = НАСТРОЙКИ["минимална_оферта"]
        печалба = round(оферта - себестойност, 2)

    марж = round((печалба / оферта) * 100, 2)

    return {
        "описание": данни["описание"],
        "трудност": данни["трудност"],
        "часове": данни["часове"],
        "разстояние": данни["разстояние"],
        "материали": материали,
        "разходи": {
            "материали": общо_материали,
            "труд": труд,
            "данък_труд": данък_труд,
            "транспорт": транспорт,
            "общи_разходи": общи_разходи,
            "себестойност": себестойност
        },
        "оферта": {
            "крайна_цена": оферта,
            "печалба": печалба,
            "марж_процент": марж
        }
    }
