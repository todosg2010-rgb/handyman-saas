from typing import Dict, List

# =========================
# ENGINE VERSION
# =========================

ENGINE_VERSION = "1.0"

# =========================
# DEFAULT SETTINGS
# =========================

НАСТРОЙКИ = {
    "часова_ставка": 45.0,      # default / fallback
    "данък": 0.20,
    "общи_разходи": 0.10,
    "печалба": 0.30,
    "минимална_оферта": 120.0,
    "цена_на_км": 1.20,
    "такса_посещение": 15.0
}

# =========================
# MAIN ENGINE
# =========================

def изчисли_оферта(данни: Dict, настройки: Dict = НАСТРОЙКИ) -> Dict:
    # -------- Safe inputs --------
    описание = данни.get("описание", "")
    часове = float(данни.get("часове", 0))
    разстояние = float(данни.get("разстояние", 0))
    входни_материали = данни.get("материали", [])

    # Hourly rate (explicit, professional)
    часова_ставка = float(
        данни.get("часова_ставка", настройки["часова_ставка"])
    )

    # -------- Materials --------
    материали: List[Dict] = []
    общо_материали = 0.0

    for m in входни_материали:
        име = m.get("име", "Материал")
        единична_цена = float(m.get("единична_цена", m.get("cena", 0)))
        количество = float(m.get("количество", m.get("kolichestvo", 0)))

        стойност = round(единична_цена * количество, 2)
        общо_материали += стойност

        материали.append({
            "тип": "материал",
            "име": име,
            "единична_цена": единична_цена,
            "количество": количество,
            "стойност": стойност
        })

    # -------- Labor (explicit) --------
    труд = round(часове * часова_ставка, 2)
    данък_труд = round(труд * настройки["данък"], 2)

    труд_елемент = {
        "тип": "труд",
        "часове": часове,
        "ставка": часова_ставка,
        "стойност": труд
    }

    # -------- Transport --------
    транспорт = round(
        настройки["такса_посещение"]
        + разстояние * настройки["цена_на_км"],
        2
    )

    # -------- Overhead --------
    общи_разходи = round(
        (общо_материали + труд) * настройки["общи_разходи"],
        2
    )

    # -------- Cost & Profit --------
    себестойност = round(
        общо_материали
        + труд
        + данък_труд
        + транспорт
        + общи_разходи,
        2
    )

    печалба = round(себестойност * настройки["печалба"], 2)
    крайна_цена = round(себестойност + печалба, 2)

    if крайна_цена < настройки["минимална_оферта"]:
        крайна_цена = настройки["минимална_оферта"]
        печалба = round(крайна_цена - себестойност, 2)

    марж = round((печалба / крайна_цена) * 100, 2) if крайна_цена else 0

    # -------- Final response --------
    return {
        "engine_version": ENGINE_VERSION,

        "описание": описание,
        "часове": часове,
        "часова_ставка": часова_ставка,
        "разстояние": разстояние,

        "материали": материали,
        "труд": труд_елемент,

        "разходи": {
            "материали": round(общо_материали, 2),
            "труд": труд,
            "данък_труд": данък_труд,
            "транспорт": транспорт,
            "общи_разходи": общи_разходи,
            "себестойност": себестойност
        },

        "оферта": {
            "крайна_цена": крайна_цена,
            "печалба": печалба,
            "марж_процент": марж
        },

        # Machine-friendly summary (DB / analytics)
        "summary": {
            "total_cost": себестойност,
            "total_price": крайна_цена,
            "profit": печалба,
            "margin_percent": марж
        }
    }
