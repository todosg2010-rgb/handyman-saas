from typing import Dict, List


# =========================
# SETTINGS
# =========================

НАСТРОЙКИ = {
    "часова_ставка": 45.0,
    "данък": 0.20,
    "общи_разходи": 0.10,
    "печалба": 0.30,
    "минимална_оферта": 120.0,
    "цена_на_км": 1.20,
    "такса_посещение": 15.0
}

МНОЖИТЕЛ_ТРУДНОСТ = {
    "лесна": 1.0,
    "средна": 1.25,
    "трудна": 1.5,
    "експертна": 2.0
}


# =========================
# MAIN ENGINE
# =========================

def изчисли_оферта(данни: Dict) -> Dict:
    # -------- Safe inputs --------
    описание = данни.get("описание", "")
    трудност = данни.get("трудност", "лесна")
    часове = float(данни.get("часове", 0))
    разстояние = float(данни.get("разстояние", 0))
    входни_материали = данни.get("материали", [])

    # -------- Normalize difficulty --------
    if isinstance(трудност, (int, float)):
        трудност = {
            1: "лесна",
            2: "средна",
            3: "трудна",
            4: "експертна"
        }.get(int(трудност), "лесна")

    множител = МНОЖИТЕЛ_ТРУДНОСТ.get(трудност, 1.0)

    # -------- Materials calculation --------
    общо_материали = 0.0
    материали: List[Dict] = []

    for m in входни_материали:
        име = m.get("име", "Материал")
        единична_цена = float(m.get("единична_цена", m.get("cena", 0)))
        количество = float(m.get("количество", m.get("kolichestvo", 0)))

        стойност = round(единична_цена * количество, 2)
        общо_материали += стойност

        материали.append({
            "име": име,
            "единична_цена": единична_цена,
            "количество": количество,
            "стойност": стойност
        })

    # -------- Labor --------
    базов_труд = часове * НАСТРОЙКИ["часова_ставка"]
    труд = round(базов_труд * множител, 2)
    данък_труд = round(труд * НАСТРОЙКИ["данък"], 2)

    # -------- Transport --------
    транспорт = round(
        НАСТРОЙКИ["такса_посещение"]
        + разстояние * НАСТРОЙКИ["цена_на_км"],
        2
    )

    # -------- Overhead --------
    общи_разходи = round(
        (общо_материали + труд) * НАСТРОЙКИ["общи_разходи"],
        2
    )

    # -------- Cost & profit --------
    себестойност = round(
        общо_материали + труд + данък_труд + транспорт + общи_разходи,
        2
    )

    печалба = round(себестойност * НАСТРОЙКИ["печалба"], 2)
    крайна_цена = round(себестойност + печалба, 2)

    if крайна_цена < НАСТРОЙКИ["минимална_оферта"]:
        крайна_цена = НАСТРОЙКИ["минимална_оферта"]
        печалба = round(крайна_цена - себестойност, 2)

    марж = round((печалба / крайна_цена) * 100, 2) if крайна_цена else 0

    # -------- Final response --------
    return {
        "описание": описание,
        "трудност": трудност,
        "часове": часове,
        "разстояние": разстояние,
        "материали": материали,
        "разходи": {
            "материали": round(общо_материали, 2),
            "труд": труд,
            "данък_труд": данък_труд,
            "транспорт": транспорт,
            "общи_разходи": общи_разходи,
            "себестойност": себестойност
        },
        "оферта": {
            "крайна_цена": крайна_цена,
            "печалба": печалба,
            "марж_процент": марж
        }
    }

