from typing import Dict, List

ENGINE_VERSION = "1.4"

DEFAULTS = {
    "часова_ставка": 45.0,
    "данък": 0.20,
    "общи_разходи": 0.10,
    "цена_на_км": 1.20,
    "такса_посещение": 15.0,
    "печалба_процент": 30.0  # MARKUP % on cost
}


def generate_client_message(
    описание: str,
    труд: float,
    материали: float,
    транспорт: float,
    крайна_цена: float
) -> str:
    """
    Generates a full, transparent, ready-to-send client message.
    Suitable for Viber / WhatsApp.
    """

    return f"""Здравейте!

Изготвих оферта за:
{описание}

Разбивка на цената:
• Труд: {труд:.2f} €
• Материали: {материали:.2f} €
• Транспорт: {транспорт:.2f} €

Крайна цена: {крайна_цена:.2f} €

Цената включва всички разходи.
Ако имате въпроси – насреща съм.
"""


def изчисли_оферта(данни: Dict, настройки: Dict = DEFAULTS) -> Dict:
    # -------- Inputs --------
    описание = данни.get("описание", "строително-монтажни работи")
    часове = float(данни.get("часове", 0))
    разстояние = float(данни.get("разстояние", 0))
    материали_вход = данни.get("материали", [])

    часова_ставка = float(
        данни.get("часова_ставка", настройки["часова_ставка"])
    )

    печалба_процент = float(
        данни.get("печалба_процент", настройки["печалба_процент"])
    )

    # -------- Materials --------
    материали: List[Dict] = []
    общо_материали = 0.0

    for m in материали_вход:
        име = m.get("име", "Материал")
        единична_цена = float(m.get("единична_цена", 0))
        количество = float(m.get("количество", 0))

        стойност = round(единична_цена * количество, 2)
        общо_материали += стойност

        материали.append({
            "име": име,
            "количество": количество,
            "единична_цена": единична_цена,
            "стойност": стойност
        })

    # -------- Labor --------
    труд = round(часове * часова_ставка, 2)
    данък_труд = round(труд * настройки["данък"], 2)

    # -------- Transport --------
    транспорт = round(
        настройки["такса_посещение"] +
        разстояние * настройки["цена_на_км"],
        2
    )

    # -------- Overhead --------
    общи_разходи = round(
        (общо_материали + труд) * настройки["общи_разходи"],
        2
    )

    # -------- COST --------
    себестойност = round(
        общо_материали +
        труд +
        данък_труд +
        транспорт +
        общи_разходи,
        2
    )

    # -------- PROFIT (MARKUP %) --------
    печалба = round(
        себестойност * (печалба_процент / 100),
        2
    )

    крайна_цена = round(
        себестойност + печалба,
        2
    )

    # -------- CLIENT MESSAGE --------
    клиентско_съобщение = generate_client_message(
        описание=описание,
        труд=труд,
        материали=общо_материали,
        транспорт=транспорт,
        крайна_цена=крайна_цена
    )

    # -------- OUTPUT --------
    return {
        "engine_version": ENGINE_VERSION,

        # Internal (DB / analytics / owner only)
        "internal": {
            "себестойност": себестойност,
            "печалба": печалба,
            "марж_процент": round(
                (печалба / себестойност) * 100, 2
            ) if себестойност else 0
        },

        # Client-facing (safe to send)
        "client": {
            "препоръчителна_цена": крайна_цена,
            "съобщение": клиентско_съобщение
        },

        # Detailed costs (internal display)
        "разходи": {
            "материали": round(общо_материали, 2),
            "труд": труд,
            "данък_труд": данък_труд,
            "транспорт": транспорт,
            "общи_разходи": общи_разходи
        },

        "материали": материали,
        "описание": описание
    }
